name: Dependency Updates

on:
  schedule:
    - cron: '0 10 * * 1'  # æ¯é€±æœˆæ›œæ—¥ã®åˆå‰10æ™‚ï¼ˆUTCï¼‰
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update_dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        cache: true

    - name: Get current dependencies
      run: flutter pub deps --json > deps_before.json

    - name: Update dependencies
      run: |
        flutter pub upgrade --major-versions
        flutter pub get

    - name: Get updated dependencies
      run: flutter pub deps --json > deps_after.json

    - name: Run tests after update
      run: flutter test

    - name: Check for analysis issues
      run: dart analyze --fatal-infos

    - name: Validate package
      run: dart pub publish --dry-run

    - name: Generate dependency update report
      id: dep_report
      run: |
        echo "## ä¾å­˜é–¢ä¿‚ã®æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ" > dependency_report.md
        echo "" >> dependency_report.md
        echo "### æ›´æ–°å‰å¾Œã®æ¯”è¼ƒ" >> dependency_report.md
        echo "" >> dependency_report.md
        
        # ç°¡å˜ãªå·®åˆ†è¡¨ç¤ºï¼ˆå®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã‚ˆã‚Šè©³ç´°ãªæ¯”è¼ƒãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ï¼‰
        if ! diff -q deps_before.json deps_after.json > /dev/null; then
          echo "ä¾å­˜é–¢ä¿‚ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ" >> dependency_report.md
          echo "" >> dependency_report.md
          echo "### ãƒ†ã‚¹ãƒˆçµæœ" >> dependency_report.md
          echo "- âœ… å…¨ãƒ†ã‚¹ãƒˆãŒæˆåŠŸ" >> dependency_report.md
          echo "- âœ… é™çš„è§£æãŒæˆåŠŸ" >> dependency_report.md
          echo "- âœ… ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æ¤œè¨¼ãŒæˆåŠŸ" >> dependency_report.md
        else
          echo "æ›´æ–°å¯èƒ½ãªä¾å­˜é–¢ä¿‚ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >> dependency_report.md
        fi
        
        # PRã®ä½œæˆãŒå¿…è¦ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        if ! diff -q deps_before.json deps_after.json > /dev/null; then
          echo "create_pr=true" >> $GITHUB_OUTPUT
        else
          echo "create_pr=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Pull Request
      if: steps.dep_report.outputs.create_pr == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: ä¾å­˜é–¢ä¿‚ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°"
        title: "ğŸ”„ Dependencies Update - $(date +'%Y-%m-%d')"
        body-path: dependency_report.md
        branch: dependencies/auto-update
        delete-branch: true
        labels: |
          dependencies
          automated
        reviewers: |
          ${{ github.repository_owner }}

  security_audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        cache: true

    - name: Install dependencies
      run: flutter pub get

    - name: Run dependency audit
      continue-on-error: true
      run: |
        # å°†æ¥çš„ã«ã¯dart pub auditã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨äºˆå®š
        flutter pub deps --json > security_deps.json
        echo "ä¾å­˜é–¢ä¿‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ"

    - name: Check for known vulnerabilities
      id: vuln_check
      continue-on-error: true
      run: |
        # OSV (Open Source Vulnerabilities) ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ç…§åˆ
        # å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯å°‚ç”¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨
        echo "è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ"
        echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT

    - name: Create security issue
      if: steps.vuln_check.outputs.vulnerabilities_found == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§æ¤œå‡º - ${new Date().toISOString().split('T')[0]}`,
            body: `è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã«ã‚ˆã‚Šã€æ½œåœ¨çš„ãªè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚\n\nè©³ç´°ç¢ºèªã¨å¯¾å¿œã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚`,
            labels: ['security', 'priority-high', 'automated']
          });

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: security_deps.json
        retention-days: 30